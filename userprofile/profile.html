<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CodeMaster | Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-gray-50 font-sans">

  <!-- Navigation -->
  <nav class="fixed top-0 w-full z-50 bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2">
          <i class="fas fa-code text-2xl"></i>
          <span class="text-xl font-bold">CodeMaster</span>
        </div>
        <div id="navProfile" class="hidden md:flex items-center space-x-2 bg-white text-purple-600 px-3 py-1 rounded-full font-semibold">
          <span id="navAvatar" class="rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold"></span>
          <span id="navName"></span>
        </div>
      </div>
      <div class="hidden md:flex space-x-6">
        <a href="../index.html">Home</a>        
        <a href="lessons.html" class="hover:text-gray-300 transition">Lessons</a>
        <a href="exercises.html" class="hover:text-gray-300 transition">Exercises</a>
        <a href="#profile" class="hover:text-gray-200 transition underline">Profile</a>
        <a href="#" onclick="signOut()" class="hover:text-red-300 transition">Sign Out</a>
      </div>
      <button id="menu-toggle" class="md:hidden text-white focus:outline-none">
        <i id="menu-icon" class="fas fa-bars text-2xl"></i>
      </button>
    </div>

        <!-- Mobile menu placed outside the flex container -->
    <div class="md:hidden hidden gradient-bg" id="mobile-menu">
      <div class="container mx-auto px-4 py-4 flex flex-row space-x-4 justify-center">        
        <a href="../index.html" class="hover:text-gray-300 transition">Home</a>
        <a href="../lessons.html" class="hover:text-gray-300 transition">Lessons</a>
        <a href="../exercises.html" class="hover:text-gray-300 transition">Exercises</a>
        <a href="#profile" class="hover:text-gray-200 transition underline">Profile</a>
        <a href="#" onclick="signOut()" class="hover:text-red-300 transition">Sign Out</a>
        <div id="navProfile" class="hidden md:flex items-center space-x-2 bg-white text-purple-600 px-3 py-1 rounded-full font-semibold">
          <span id="navAvatar" class="rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold"></span>
          <span id="navName"></span>
        </div>
      </div>
      <hr>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="py-20">
    <div class="container mx-auto px-4 max-w-4xl">
      <h1 class="text-3xl font-bold mb-8 text-purple-700">Your Learning Dashboard</h1>

      <!-- Progress Bars -->

      <!-- Badges -->

    <!-- Profile -->
    <section id="profile" class="mt-12 max-w-4xl mx-auto px-4">
      <h2 class="text-3xl font-bold mb-6 text-indigo-700">Your Profile</h2>
      <div class="bg-white shadow-md rounded-lg p-6 space-y-4">
        <div class="flex items-center space-x-4">
          <div id="profileAvatar" class="text-white rounded-full w-12 h-12 flex items-center justify-center text-xl font-bold"></div>
          <div class="flex-1">
            <input id="profileName" type="text" placeholder="Your Name" class="border px-3 py-2 rounded w-full" />
            <input id="profileTagline" type="text" placeholder="Your Tagline" class="border px-3 py-2 rounded w-full mt-2" />
          </div>
        </div>
        <button id="saveBtn" onclick="saveProfile()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Save Profile</button>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white py-12 mt-16">
    <div class="container mx-auto px-4 text-center">
      <p class="text-gray-400">&copy; 2025 CodeMaster. Built by Mark.</p>
    </div>
  </footer>

<script>
  const API_BASE = "https://code-master-kk2m.onrender.com/api";

  function updateNavProfile() {
    const name = localStorage.getItem("codemasterUserName");
    if (name) {
      document.getElementById("navProfile")?.classList.remove("hidden");
      document.getElementById("navName")?.textContent = name;
      document.getElementById("navAvatar")?.textContent = name.charAt(0).toUpperCase();
    }
  }

  function renderProfileUI() {
    const name = localStorage.getItem("codemasterUserName") || "";
    const tagline = localStorage.getItem("codemasterTagline") || "";

    const avgProgress = Object.keys(allLessons).reduce((sum, subject) => {
      const key = `${subject}LessonProgress`;
      return sum + (parseInt(localStorage.getItem(key)) || 0);
    }, 0) / Object.keys(allLessons).length;

    const color = avgProgress >= 80 ? "bg-green-600"
                : avgProgress >= 50 ? "bg-blue-600"
                : "bg-purple-600";

    const nameInput = document.getElementById("profileName");
    const taglineInput = document.getElementById("profileTagline");
    const avatar = document.getElementById("profileAvatar");

    if (nameInput) nameInput.value = name;
    if (taglineInput) taglineInput.value = tagline;
    if (avatar) {
      avatar.textContent = name ? name.charAt(0).toUpperCase() : "?";
      avatar.className = `${color} text-white rounded-full w-12 h-12 flex items-center justify-center text-xl font-bold`;
    }
  }

  function loadProfileFromBackend() {
    fetch(`${API_BASE}/profile/me`, {
      credentials: "include"
    })
      .then(res => {
        if (res.status === 401) {
          alert("Session expired. Redirecting to login...");
          window.location.href = "/auth.html";
          return;
        }
        if (!res.ok) throw new Error(`Server responded with ${res.status}`);
        return res.json();
      })
      .then(data => {
        console.log("✅ Profile data received:", data);
        if (data?.username) {
          localStorage.setItem("codemasterUserName", data.username);
          localStorage.setItem("codemasterTagline", data.bio || "");
          updateNavProfile();
          renderProfileUI();
        }
      })
      .catch(err => {
        console.warn("⚠️ Failed to load profile from backend:", err.message || err);
        alert("Unable to load profile. Please sign in again.");
        window.location.href = "/auth.html";
      });
  }

  function saveProfile() {
    const name = document.getElementById("profileName")?.value.trim();
    const tagline = document.getElementById("profileTagline")?.value.trim();

    if (!name || name.length < 2) {
      alert("Please enter a valid name.");
      return;
    }

    localStorage.setItem("codemasterUserName", name);
    localStorage.setItem("codemasterTagline", tagline);
    updateNavProfile();
    renderProfileUI();

    const button = document.getElementById("saveBtn");
    if (button) {
      button.disabled = true;
      button.textContent = "Saving...";
    }

    fetch(`${API_BASE}/profile/me`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      credentials: "include",
      body: JSON.stringify({ username: name, bio: tagline })
    })
      .then(res => {
        if (!res.ok) throw new Error(`Server responded with ${res.status}`);
        return res.json();
      })
      .then(data => {
        console.log("✅ Profile synced with backend:", data);
        alert("Profile saved and synced!");
      })
      .catch(err => {
        console.error("❌ Profile sync failed:", err.message || err);
        alert("Failed to sync profile with server.");
      })
      .finally(() => {
        if (button) {
          button.disabled = false;
          button.textContent = "Save Profile";
        }
      });
  }

  function signOut() {
    fetch(`${API_BASE}/auth/logout`, {
      method: "POST",
      credentials: "include"
    })
      .then(() => {
        localStorage.clear();
        window.location.href = "/auth.html";
      })
      .catch(err => {
        console.error("❌ Logout failed:", err.message || err);
        alert("Could not log out. Try again.");
      });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const toggleBtn = document.getElementById("menu-toggle");
    const menuIcon = document.getElementById("menu-icon");
    const mobileMenu = document.getElementById("mobile-menu");

    toggleBtn?.addEventListener("click", () => {
      mobileMenu?.classList.toggle("hidden");
      menuIcon?.classList.toggle("fa-bars");
      menuIcon?.classList.toggle("fa-times");
    });
  });

  window.addEventListener("load", () => {
    loadProfileFromBackend();
    setTimeout(() => {
      updateNavProfile();
      renderProfileUI();
    }, 100);
    renderProgressBars();
    renderBadges();
  });
</script> 
</body>
</html>